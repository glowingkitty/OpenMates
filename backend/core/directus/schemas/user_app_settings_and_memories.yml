# File: backend/core/directus/schemas/user_app_settings_and_memories.yml
# Description: Defines the schema for the 'user_app_settings_and_memories' collection in Directus.
# This collection stores individual encrypted items (watched movies, restaurants, trips, etc.) for app settings and memories.
#
# Scalability Architecture:
# - Every individual item (movie, restaurant, trip, etc.) is a separate Directus row
# - Each app/user combination has a unique encryption_key_user_app (shared across all items in that app)
# - The app encryption key is encrypted with the user's master encryption key for device sync
# - All items are encrypted client-side before upload
# - Server stores only encrypted items + hashed identifiers, never plaintext data
# - Enables server-side pagination, sorting, and efficient selective sync
# - Settings group names are hashed (server cannot identify which group, e.g., "watched_movies")
#
# Reference: docs/architecture/security.md#app-settings--memories

user_app_settings_and_memories:
  type: collection
  fields:
    id:
      type: uuid
      primary: true
      note: "Primary Key - Unique identifier for this item"

    hashed_user_id:
      type: string
      length: 255
      note: "[Indexed] Hashed identifier of the user. Backend hashes user's actual ID before storing/querying."

    app_hash:
      type: string
      length: 64
      note: "[Indexed] SHA256(app_id + user_email_salt). Allows filtering by app without revealing which app. Server cannot identify app."

    settings_group_hash:
      type: string
      length: 64
      note: "[Indexed] SHA256(settings_group_key + user_email_salt). Allows filtering by group (e.g., 'watched_movies', 'to_watch_list', 'favorite_restaurants') without revealing group names."

    encrypted_app_key:
      type: string
      length: 512
      note: "[Encrypted] App-specific encryption key (unique per app/user combo), encrypted with user's master key for device sync. Same for all items in an app. Client decrypts once and reuses for all items."

    encrypted_item_json:
      type: text
      note: "[Encrypted] Single item encrypted with app-specific key. Structure defined in each app's app.yml (e.g., backend/apps/tv/app.yml). Examples: one movie, one restaurant, one trip."

    created_at:
      type: integer
      note: "Unix timestamp (seconds) when this item was created"

    updated_at:
      type: integer
      note: "Unix timestamp (seconds) when this item was last updated"

    sequence_number:
      type: integer
      note: "Optional ordering number maintained by client for maintaining custom sort order within a settings group"

    item_version:
      type: integer
      default: 1
      note: "Version number for this item, increments with each update. Maintained by client for conflict detection and multi-device sync coordination. Server cannot modify; only client controls versioning."