invoices:
  type: collection
  fields:
    id:
      type: uuid
      primary: true

    order_id:
      type: string
      length: 255
      note: "The order ID from the payment provider"

    user_id_hash:
      type: string
      length: 512
      note: "Hash of the user ID who made the purchase"

    date:
      type: datetime

    encrypted_amount:
      type: string
      length: 512
      note: "Encrypted invoice amount"

    encrypted_s3_object_key:
      type: string
      length: 512
      note: "Encrypted S3 object key for the invoice"

    encrypted_aes_key:
      type: string
      length: 512
      note: "Encrypted AES key for the invoice"

    aes_nonce:
      type: string
      length: 512
      note: "Nonce used for AES encryption"

    encrypted_credits_purchased:
      type: string
      length: 512
      note: "Encrypted number of credits this invoice was for"

    encrypted_filename:
      type: string
      length: 512
      note: "Encrypted filename of the invoice"

    has_chargeback:
      type: boolean
      note: "Whether this invoice had a chargeback/dispute"
      default: false

    chargeback_date:
      type: string
      length: 256
      nullable: true
      note: "ISO timestamp when chargeback/dispute was created"

    is_gift_card:
      type: boolean
      note: "Whether this invoice is for a gift card purchase (as opposed to a regular credit purchase)"
      default: false

    refunded_at:
      type: string
      length: 256
      nullable: true
      note: "ISO timestamp when refund was processed (null if not refunded)"

    encrypted_refunded_credits:
      type: string
      length: 512
      nullable: true
      note: "Encrypted number of credits that were refunded"

    encrypted_refund_amount:
      type: string
      length: 512
      nullable: true
      note: "Encrypted refund amount in cents (same currency as invoice)"

    refund_status:
      type: string
      length: 50
      nullable: true
      note: "Status of refund: 'none' (no refund), 'pending' (refund requested but not processed), 'completed' (refund processed), 'failed' (refund failed)"
      default: "none"

    provider:
      type: string
      length: 50
      nullable: true
      note: "Payment provider used for this purchase: 'stripe', 'polar', 'revolut'. Null for legacy invoices created before this field was added."

    provider_order_id:
      type: string
      length: 255
      nullable: true
      note: "Provider-specific order ID needed for refunds. For Polar: the Polar Order UUID (different from checkout session ID stored in order_id). For Stripe: null (order_id is the PaymentIntent ID). For Revolut: null (order_id is the Revolut order ID)."
