# backend/core/directus/schemas/embed_keys.yml
# Defines the schema for the 'embed_keys' collection in Directus.
# 
# Stores multiple wrapped versions of embed encryption keys, similar to how user_lookup_hashes
# stores multiple wrapped versions of the master key for different login methods.
# 
# This architecture enables:
# - Owner cross-chat access: Use master_key to unwrap embed_key
# - Shared chat access: Use chat_key to unwrap embed_key (for offline sharing)
# - Independent embed sharing: Include embed_key in share link fragment
#
# Each embed can have multiple key entries:
# - One entry with key_type="master" for owner access (via master key)
# - One entry per chat with key_type="chat" for shared chat access (via chat key)
#
# When an embed is created in a chat:
# 1. Generate random embed_key
# 2. Encrypt content with embed_key
# 3. Create master key entry: AES(embed_key, master_key)
# 4. Create chat key entry: AES(embed_key, chat_key)
#
# When embed is copied to a new chat:
# 1. Decrypt embed_key using master key
# 2. Create new chat key entry: AES(embed_key, new_chat_key)
# 3. Simple INSERT - no read-modify-write needed
embed_keys:
  type: collection
  fields:
    id:
      type: uuid
      note: "Primary Key - auto-generated by Directus"
    
    hashed_embed_id:
      type: string
      note: "[Indexed] SHA256 hash of embed_id. References the embed this key belongs to. Hashed for privacy. NOT unique - same embed can have multiple chat keys (one per chat)."
    
    key_type:
      type: string
      note: "[Indexed] Type of key wrapper: 'master' (wrapped with user's master key) or 'chat' (wrapped with chat's encryption key)"
    
    hashed_chat_id:
      type: string
      note: "[Indexed, Nullable] For key_type='chat': SHA256(chat_id) indicating which chat's key was used to wrap. Null for key_type='master'."
    
    encrypted_embed_key:
      type: string
      note: "The embed's encryption key wrapped with the appropriate key. For key_type='master': AES(embed_key, master_key). For key_type='chat': AES(embed_key, chat_key)."
    
    hashed_user_id:
      type: string
      note: "[Indexed] Hashed user ID of embed owner (for access control and queries)"
    
    created_at:
      type: integer
      note: "Unix timestamp (seconds) when this key entry was created"

