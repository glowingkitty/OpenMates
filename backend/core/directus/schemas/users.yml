directus_users:
  type: collection
  fields:
    is_admin:
      type: boolean
      note: "Is the user an admin?"

    last_opened:
      type: string
      length: 512
      note: "Last opened chat or signup step. Example: /chats/1234, /signup/step-3"

    signup_completed:
      type: boolean
      default: false
      note: "Is the signup process fully completed?"

    last_online_timestamp:
      type: string
      length: 256
      note: "Timestamp of the last time the user was online"

    darkmode:
      type: boolean
      note: "Is dark mode enabled?"

    encrypted_email_address:
      type: string
      length: 512
      note: "Encrypted email address (encrypted with email_encryption_key for server use)"
    
    encrypted_email_with_master_key:
      type: string
      length: 512
      note: "Email encrypted with master key (for passwordless passkey login - allows client to decrypt without email_encryption_key)"

    encrypted_username:
      type: string
      length: 512
      note: "Encrypted username"

    encrypted_profileimage_url:
      type: string
      length: 512
      note: "Encrypted profile image URL"

    encrypted_credit_balance:
      type: string
      length: 512
      note: "Encrypted credit balance"

    encrypted_gifted_credits_for_signup:
      type: string
      length: 512
      note: "Encrypted gifted credits for signup"

    encrypted_invoice_counter:
      type: string
      length: 512
      note: "Encrypted counter for user's invoices (starts at 0)"

    encrypted_settings:
      type: textfield
      note: "Encrypted user preferences"

    connected_devices:
      type: json
      note: "A JSON array of known device hashes for the user."

    vault_key_id:
      type: string
      length: 64
      note: "Reference to the user's encryption key in Vault"

    vault_key_version:
      type: string
      length: 64
      note: "Version of the user's encryption key in Vault"

    api_key_hash:
      type: string
      length: 128
      note: "Legacy field - kept for backward compatibility (deprecated, use api_keys collection instead)"

    encrypted_tfa_secret:
      type: string
      length: 512
      note: "Encrypted 2FA secret key"

    tfa_backup_codes_hashes:
      type: textfield
      note: "Array of Argon2 hashed backup codes"

    encrypted_tfa_app_name:
      type: string
      length: 256
      note: "Encrypted name of the 2FA app used by the user"

    tfa_last_used:
      type: string
      length: 256
      note: "Timestamp of when 2FA was last successfully used"
    
    consent_tfa_safely_stored_timestamp:
      type: string
      length: 256
      note: "Timestamp of when the user consented to store 2FA safely"
      
    hashed_email:
      type: string
      length: 256
      note: "SHA-256 hash of the email address for user lookup during login"
      
    user_email_salt:
      type: string
      length: 256
      note: "Salt used for client-side email encryption (base64)"
      
    lookup_hashes:
      type: json
      note: "Array of SHA-256 hashes of email+login_secret for zero-knowledge authentication across different login methods"

    consent_privacy_and_apps_default_settings:
      type: string
      length: 256
      note: "Timestamp of when the user consented to default privacy and app settings"

    consent_mates_default_settings:
      type: string
      length: 256
      note: "Timestamp of when the user consented to default mates settings"

    account_id:
      type: string
      length: 7
      note: "Unique 7-character account identifier for invoices and customer-facing references (A-Z, 0-9)"

    consent_recovery_key_stored_timestamp:
      type: string
      length: 256
      note: "Timestamp of when the user consented to store recovery key safely"

    # Monthly subscription fields
    encrypted_payment_method_id:
      type: string
      length: 512
      note: "Encrypted Stripe payment_method ID for monthly auto top-up subscriptions"
    
    stripe_customer_id:
      type: string
      length: 255
      note: "Stripe customer ID (not sensitive, safe as cleartext)"
    
    stripe_subscription_id:
      type: string
      length: 255
      note: "Stripe subscription ID for active monthly auto top-up (not sensitive, safe as cleartext)"
    
    subscription_status:
      type: string
      length: 50
      note: "Status of the subscription (active, canceled, past_due, etc.)"
    
    subscription_credits:
      type: integer
      note: "Base credits amount for the monthly subscription (used to lookup tier in pricing.yml)"
    
    subscription_currency:
      type: string
      length: 3
      note: "Currency for the subscription (eur, usd, jpy)"
    
    next_billing_date:
      type: string
      length: 256
      note: "Next billing date for the subscription (ISO 8601 format)"

    # Low balance auto top-up fields
    auto_topup_low_balance_enabled:
      type: boolean
      note: "Enable automatic one-time top-up when balance falls below threshold"

    auto_topup_low_balance_threshold:
      type: integer
      note: "Credit threshold that triggers auto top-up (fixed at 100 credits, cannot be changed to simplify setup)"

    auto_topup_low_balance_amount:
      type: integer
      note: "Credits to purchase when threshold crossed (must match a pricing tier)"

    auto_topup_low_balance_currency:
      type: string
      length: 3
      note: "Currency for auto top-up purchases (eur, usd, jpy)"

    encrypted_auto_topup_last_triggered:
      type: string
      length: 512
      note: "Encrypted timestamp of last auto top-up to prevent rapid retriggering"

    encrypted_email_auto_topup:
      type: string
      length: 512
      note: "Server-encrypted email address for auto top-up notifications (encrypted with user's vault key)"

    encrypted_hidden_demo_chats:
      type: textfield
      note: "Encrypted JSON array of demo chat IDs that user has dismissed/deleted (e.g., ['demo-welcome', 'demo-power-of-apps']). Syncs across devices."

    encrypted_top_recommended_apps:
      type: text
      note: "[Encrypted] Array of top 5 recommended app IDs for this user, encrypted using user's master key. Aggregated client-side from recent chat recommendations. Format: ['app1', 'app2', ...]. Must be TEXT not JSON since it's encrypted."

    # Payment tier system fields
    payment_tier:
      type: integer
      note: "Current payment tier (0-4). Tier 0: No card payments allowed (SEPA only, after 2 chargebacks), Tier 1: 75€/month (new users or after 1 chargeback), Tier 2: 150€/month (3 months without chargeback), Tier 3: 300€/month (6 months without chargeback), Tier 4: 500€/month (12 months without chargeback)"
      default: 1

    chargeback_count:
      type: integer
      note: "Total number of chargebacks/disputes this user has had (used for graduated penalty system: 1 chargeback → Tier 1, 2+ chargebacks → Tier 0)"
      default: 0

    consecutive_months_without_chargeback:
      type: integer
      note: "Number of consecutive months with successful payments and no chargebacks (used for tier progression)"
      default: 0

    last_chargeback_date:
      type: string
      length: 256
      nullable: true
      note: "ISO timestamp of the last chargeback (resets consecutive_months_without_chargeback counter)"

    encrypted_current_month_spending_eur:
      type: string
      length: 512
      note: "Encrypted total EUR spent in current calendar month (for tier limit checking). Reset at start of each month."

    current_month_start_timestamp:
      type: integer
      note: "Unix timestamp (seconds) of the start of the current month (for resetting monthly spending counter)"
      default: 0

    last_successful_payment_date:
      type: string
      length: 256
      nullable: true
      note: "ISO timestamp of last successful payment (for tracking months with payments to increment consecutive_months_without_chargeback)"

    consent_withdrawal_waiver_timestamp:
      type: string
      length: 256
      nullable: true
      note: "ISO timestamp of when the user consented to the withdrawal waiver (agreed to immediate execution of digital services, acknowledging that withdrawal right expires once credits are used). Required for EU/German consumer law compliance."
