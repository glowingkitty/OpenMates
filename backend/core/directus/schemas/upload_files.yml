# backend/core/directus/schemas/upload_files.yml
#
# Directus collection for tracking uploaded files.
# Used by app-uploads service for:
#   1. Deduplication: same user uploading the same file twice gets an instant
#      response with the existing embed_id and stored S3 keys.
#   2. Record-keeping for potential future cleanup (e.g., when the parent chat
#      is deleted, sweep these S3 objects too).
#
# Security notes:
#   - aes_key and vault_wrapped_aes_key are stored here in plaintext for
#     deduplication lookups. This is intentional — the server already has access
#     to these via Vault (vault_wrapped_aes_key). The plaintext aes_key is also
#     returned to the client and stored inside client-encrypted embed content, so
#     storing it here does not weaken the security model.
#   - user_id is stored in plaintext for deduplication filtering. This matches
#     the pattern used in other server-side collections (usage, embeds).
#   - The content_hash field enables O(1) deduplication per user without scanning
#     file contents.
upload_files:
  type: collection
  fields:
    id:
      type: uuid
      note: "Primary Key — auto-generated by Directus."

    embed_id:
      type: string
      note: "[Indexed, Unique] The embed_id assigned to this upload. UUID v4. Used to reference the embed in chat messages."
      options:
        unique: true

    user_id:
      type: string
      note: "[Indexed] The user who uploaded the file. Used for deduplication lookups (user_id + content_hash must be unique)."

    content_hash:
      type: string
      note: "[Indexed] SHA-256 hash of the raw file bytes before encryption. Used for per-user deduplication."

    original_filename:
      type: string
      note: "Original filename as provided by the browser (e.g. 'photo.jpg')."

    content_type:
      type: string
      note: "Detected MIME type of the uploaded file (e.g. 'image/webp'). Detected via python-magic, not trusted from Content-Type header."

    file_size_bytes:
      type: integer
      note: "Size of the raw (pre-encryption) file in bytes."

    s3_base_url:
      type: string
      note: "S3 base URL for this upload (e.g. 'https://chatfiles.nbg1.your-objectstorage.com'). Used to reconstruct full S3 URLs when serving deduplicated responses."

    files_metadata:
      type: json
      note: "JSON object mapping variant names ('original', 'preview') to their S3 metadata (s3_key, width, height, size_bytes, format). Mirrors the FileVariantMetadata Pydantic model."

    aes_key:
      type: string
      note: "Base64-encoded AES-256 key used to encrypt the file. Returned to client on deduplication hit so the client can decrypt for rendering."

    aes_nonce:
      type: string
      note: "Base64-encoded AES-GCM nonce shared across all encrypted variants of this upload."

    vault_wrapped_aes_key:
      type: string
      note: "Vault Transit-wrapped AES key. Used by server-side skills (e.g. images.view) to decrypt the file without requiring the client."

    malware_scan:
      type: string
      note: "ClamAV scan result: always 'clean' (files with threats are rejected and never stored)."

    ai_detection:
      type: json
      note: "[Optional] SightEngine AI-generated content detection result. JSON object with 'ai_generated' (float 0.0-1.0) and 'provider' ('sightengine'). Null if detection was skipped."

    created_at:
      type: integer
      note: "Unix timestamp (seconds) when the upload was created."
