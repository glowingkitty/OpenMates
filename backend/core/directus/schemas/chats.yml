chats:
  type: collection
  fields:
    id: # chat_id
      type: uuid
      note: "Primary Key - Unique identifier for the chat (chat_id)"

    hashed_user_id:
      type: string
      note: "[Hashed] Backend hashes the user's actual ID before storing/querying"

    encrypted_title:
      type: text # Suitable for potentially longer titles
      note: "[Encrypted] User-defined title of the chat, encrypted using the key from Vault"

    messages_v:
      type: integer
      note: "Version number for messages, increments when a new message is added"

    title_v:
      type: integer
      note: "Version number for the title, increments when the title is updated"

    last_edited_overall_timestamp:
      type: integer
      note: "Unix timestamp (seconds) of the most recent modification to messages or draft (not title). Used for sorting chats by recency."

    unread_count:
      type: integer
      note: "Number of unread messages in this chat for the user"

    created_at:
      type: integer
      note: "Unix timestamp (seconds) when the chat was first initiated, e.g., first draft saved"

    updated_at:
      type: integer
      note: "Unix timestamp (seconds) of the last update to metadata, draft, or addition of a message"

    last_message_timestamp:
      type: integer
      note: "Unix timestamp (seconds) of the most recent completed message, for sorting"

    encrypted_active_focus_id:
      type: string
      note: "[Encrypted] ID of the currently active focus for this chat (e.g., 'travel/plan_trip'). Encrypted with chat-specific key."

    encrypted_chat_summary:
      type: text
      note: "[Encrypted] Chat summary (2-3 sentences) generated during post-processing, encrypted using chat-specific key"

    encrypted_chat_tags:
      type: text
      note: "[Encrypted] Array of max 10 tags for categorizing the chat, encrypted as base64 string using chat-specific key. Must be TEXT not JSON since it's encrypted."

    encrypted_follow_up_request_suggestions:
      type: text
      note: "[Encrypted] Array of 6 follow-up request suggestions for the current chat, encrypted as base64 string using chat-specific key. Must be TEXT not JSON since it's encrypted."

    encrypted_top_recommended_apps_for_chat:
      type: text
      note: "[Encrypted] Array of up to 5 recommended app IDs for this specific chat, encrypted using chat-specific key. Generated during post-processing. Format: ['app1', 'app2', ...]. Must be TEXT not JSON since it's encrypted."

    encrypted_chat_key:
      type: string
      length: 512
      note: "[Encrypted] Chat-specific encryption key, encrypted with user's master key for device sync"

    encrypted_icon:
      type: string
      note: "[Encrypted] Icon name from Lucide library, generated during pre-processing, encrypted using chat-specific key"

    encrypted_category:
      type: string
      note: "[Encrypted] Category name, generated during pre-processing, encrypted using chat-specific key"

    pinned:
      type: boolean
      default: false
      note: "Whether this chat is pinned. Pinned chats appear at the top of the chat list and are prioritized in sync to prevent exclusion from the last 100 synced chats."

    shared_with_user_hashes:
      type: json
      note: "Array of SHA-256 hashes of users allowed to access this chat. Initially contains hash(email) for lookup, which is upgraded to hash(user_id) after first access to allow access even after email changes. Format: ['hash1', 'hash2', ...]. Uses SHA256(user_id.encode()).hexdigest() for user_id hashing to match system convention."

    shared_public:
      type: boolean
      note: "Whether this chat is publicly shared. If true, anyone with the link can access it (subject to encryption key in URL fragment). DEPRECATED: Use is_private field instead."

    shared_timestamp:
      type: integer
      note: "Unix timestamp (seconds) marking the point up to which shared messages can be read by others. Messages with timestamps <= this value are visible to users with access. Null if chat is not shared. Updated when sharing is enabled or when the owner wants to limit message visibility to shared users."

    is_private:
      type: boolean
      default: false
      note: "Whether this chat is private (not shared). If true, the chat is not accessible via share links. Defaults to false (shareable) to enable offline sharing. When a user unshares a chat, this is set to true. The security model relies on: (1) Chat IDs are not easily guessable, (2) Encryption key in URL fragment is required to decrypt, (3) Server returns dummy data for non-existent chats to prevent enumeration, (4) Rate limiting on share endpoints."

    is_shared:
      type: boolean
      default: false
      note: "Whether this chat has been shared (share link generated). Set to true on client when share link is created, then synced to server. Used to track which chats appear in the 'Shared' menu. When unsharing, both is_private and is_shared are updated."

    share_with_community:
      type: boolean
      default: false
      note: "Whether the user has opted-in to share this chat with the community for potential selection as a demo chat. When true, the chat appears in the admin review queue."

    last_disclaimer_type:
      type: string
      nullable: true
      note: "Type of the last disclaimer injected into this chat: 'financial', 'medical', 'legal', or 'mental_health'. Used to prevent repeating same disclaimer type. Not encrypted since this is non-sensitive metadata."

    last_disclaimer_timestamp:
      type: integer
      nullable: true
      note: "Unix timestamp (seconds) when the last disclaimer was injected. Used with last_disclaimer_type to determine if a new disclaimer is needed."

    shared_encrypted_title:
      type: text
      nullable: true
      note: "[Vault-Encrypted] Title for shared chat, encrypted with shared vault key (shared-content-metadata) for OG tag generation. Only populated when is_private = false. Server can decrypt for OG tags without user context."

    shared_encrypted_summary:
      type: text
      nullable: true
      note: "[Vault-Encrypted] Summary for shared chat, encrypted with shared vault key (shared-content-metadata) for OG tag generation. Only populated when is_private = false. Server can decrypt for OG tags without user context."

# TODO: Create separate model for new_chat_request_suggestions
# According to message_processing.md, new_chat_request_suggestions should be stored separately
# (50 most recent suggestions stored in IndexedDB under separate key, not per chat)
# This will require a new collection: new_chat_suggestions with fields like:
# - id, hashed_user_id, encrypted_suggestion_text, created_at, updated_at
