# backend/core/directus/schemas/embeds.yml
# Defines the schema for the 'embeds' collection in Directus.
# Embeds are separate entities from messages, stored independently and referenced in messages via lightweight JSON blocks.
# All sensitive fields (type, chat_id, message_id, task_id) are protected client-side before storage to maintain zero-knowledge architecture.
embeds:
  type: collection
  fields:
    id:
      type: uuid
      note: "Primary Key - Unique identifier for the embed, auto-generated by Directus."
    
    embed_id:
      type: string
      note: "[Indexed] Unique identifier for the embed. Format: UUID v4. Generated by the client or server."
      options:
        unique: true
    
    hashed_chat_id:
      type: string
      note: "[Indexed] SHA256 hash of chat_id (for linking without exposing actual chat_id, protects privacy). Client-side hashed before sending to server."
    
    hashed_message_id:
      type: string
      note: "[Indexed] SHA256 hash of message_id (for linking without exposing actual message_id, protects privacy). Client-side hashed before sending to server. Can be null if referenced by multiple messages."
    
    hashed_task_id:
      type: string
      note: "[Optional] SHA256 hash of task_id (for long-running tasks, protects privacy). Used to update embed when task completes. Client-side hashed before sending to server."
    
    encrypted_type:
      type: string
      note: "[Encrypted] Type of embed encrypted client-side (app_skill_use, website, place, event, code, file, sheet, document, etc.). Server cannot determine embed type without decryption key. Encrypted with same key as encrypted_content."
    
    status:
      type: string
      note: "Status of embed: 'processing' | 'finished' | 'error'"
    
    hashed_user_id:
      type: string
      note: "[Indexed] Hashed user ID of embed owner"
    
    # NOTE: encryption_key_embed moved to embed_keys collection
    # This allows multiple wrapped versions (master key + per-chat keys) for offline sharing
    # See embed_keys.yml for the new schema
    
    share_mode:
      type: string
      note: "[Indexed] Sharing mode: 'private' | 'shared_with_user' | 'public'. Default: 'private'"
      default: "private"
    
    shared_with_users:
      type: json
      note: "[Optional] Array of hashed_user_ids who have access (for user-specific sharing)"
    
    embed_ids:
      type: json
      note: "[Optional] Array of embed IDs for composite app_skill_use embeds (e.g., web search contains embed_ids pointing to website embeds). Null for single embeds or non-app_skill_use embeds."
    
    encrypted_content:
      type: textfield
      note: "[Encrypted] Full embed content (TOON format string). For app_skill_use embeds with composite results, contains query, provider, skill name, and metadata. For single embeds (code, file, sheet, document, website, place, event), contains the actual content. Encrypted with encryption_key_embed (private) or shared_encryption_key (shared). Content is stored as TOON string for space efficiency (30-60% savings vs JSON)."
    
    encrypted_text_preview:
      type: textfield
      note: "[Encrypted] Lightweight text preview for text-based embeds (code, documents). Always synced to client for fast rendering. Encrypted with same key as encrypted_content."
    
    parent_embed_id:
      type: string
      note: "[Optional] For versioned embeds: references the parent embed_id this version is based on"
    
    version_number:
      type: integer
      note: "[Optional] Version number for this embed (starts at 1, increments on updates)"
    
    encrypted_diff:
      type: textfield
      note: "[Encrypted] For file updates: stores diff/patch between versions (unified diff format). Encrypted with same key as encrypted_content."
    
    file_path:
      type: string
      note: "[Optional] For code/file embeds: relative file path for detecting updates to same file"
    
    content_hash:
      type: string
      note: "[Indexed] SHA256 hash of embed content. Used for duplicate detection (file, code, sheet, document) and change detection (versioning). Not used for website, place, event, or app_skill_use embeds."
    
    created_at:
      type: integer
      note: "Unix timestamp (seconds) when the embed was created. Provided by the application."
    
    updated_at:
      type: integer
      note: "Unix timestamp (seconds) when the embed was last updated. Used for task completion updates and versioning."

