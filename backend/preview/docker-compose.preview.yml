# OpenMates Preview Server - Standalone Docker Compose
#
# This is the standalone deployment for the preview server,
# intended for running on a separate VM (preview.openmates.org).
#
# For self-hosted instances where everything runs on one server,
# use the commented-out preview service in the main docker-compose.yml instead.
#
# Usage:
#   # Development (with hot reload)
#   docker compose -f docker-compose.preview.yml up
#
#   # Production
#   docker compose -f docker-compose.preview.yml up -d
#
# Environment variables can be set in .env file or passed directly.
#
# Architecture: two containers
#   preview        — the main image/metadata proxy (NO Docker socket)
#   admin-sidecar  — tiny admin container with Docker socket access only
#
# Caddy on the VM should route:
#   /admin/*  →  admin-sidecar:8001
#   /*        →  preview:8080

name: openmates-preview

services:
  # ===========================================
  # Preview Server (main service)
  # ===========================================
  # Handles image/favicon proxying and URL metadata extraction.
  # Intentionally has NO Docker socket access — the admin-sidecar handles that.
  preview:
    container_name: preview
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped

    # Load environment variables from root .env file
    # This makes variables like SECRET__YOUTUBE__API_KEY available for interpolation
    env_file:
      - ../../.env

    # Environment configuration
    environment:
      # Server settings
      PREVIEW_HOST: "0.0.0.0"
      PREVIEW_PORT: "8080"
      PREVIEW_ENVIRONMENT: "${PREVIEW_ENVIRONMENT:-production}"
      PREVIEW_DEBUG: "${PREVIEW_DEBUG:-false}"
      PREVIEW_LOG_LEVEL: "${PREVIEW_LOG_LEVEL:-INFO}"
      # Workers for concurrent image processing (default: 4)
      # Each worker can process 1 image at a time
      # More workers = more concurrent requests, but more RAM usage (~300MB each)
      UVICORN_WORKERS: "${UVICORN_WORKERS:-4}"

      # Cache settings (adjust based on available disk space)
      # Total disk usage ≈ CACHE_MAX_SIZE_MB + METADATA_CACHE_MAX_SIZE_MB + ~2GB (Docker, OS, etc.)
      # For CAX11 (40GB disk): 10GB image cache leaves plenty of room
      PREVIEW_CACHE_DIR: "/app/cache"
      PREVIEW_CACHE_MAX_SIZE_MB: "${PREVIEW_CACHE_MAX_SIZE_MB:-10240}" # 10GB for images
      PREVIEW_METADATA_CACHE_MAX_SIZE_MB: "${PREVIEW_METADATA_CACHE_MAX_SIZE_MB:-500}" # 500MB for metadata

      # Image processing
      PREVIEW_MAX_IMAGE_WIDTH: "${PREVIEW_MAX_IMAGE_WIDTH:-1920}"
      PREVIEW_MAX_IMAGE_HEIGHT: "${PREVIEW_MAX_IMAGE_HEIGHT:-1080}"
      PREVIEW_JPEG_QUALITY: "${PREVIEW_JPEG_QUALITY:-85}"

      # Security
      PREVIEW_BLOCK_PRIVATE_IPS: "${PREVIEW_BLOCK_PRIVATE_IPS:-true}"
      PREVIEW_API_KEY: "${PREVIEW_API_KEY:-}" # Optional: set for API key auth

      # CORS - adjust for your domains
      PREVIEW_CORS_ORIGINS: "${PREVIEW_CORS_ORIGINS:-https://openmates.org}"

      # Referer validation - webapp only, no direct API access
      # Empty referers are NOT allowed (webapp always sends referer)
      PREVIEW_VALIDATE_REFERER: "${PREVIEW_VALIDATE_REFERER:-true}"
      PREVIEW_ALLOW_EMPTY_REFERER: "${PREVIEW_ALLOW_EMPTY_REFERER:-false}"
      PREVIEW_ALLOWED_REFERERS: "${PREVIEW_ALLOWED_REFERERS:-https://openmates.org/*,https://*.openmates.org/*}"

    # Port mapping
    ports:
      - "${PREVIEW_PORT:-8080}:8080"

    # Persistent cache storage only — NO Docker socket
    volumes:
      - preview-cache:/app/cache

    # Resource limits
    # For Hetzner CAX11 (4GB RAM, 2 CPU cores):
    # - 4 uvicorn workers (handles 4 concurrent image processing tasks)
    # - Each worker uses ~200-300MB when processing
    # - Total: ~1.5GB RAM during peak load
    deploy:
      resources:
        limits:
          memory: 2G # Room for 4 workers processing simultaneously
          cpus: "2"
        reservations:
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Admin Sidecar
  # ===========================================
  # Tiny isolated container that holds the Docker socket and ADMIN_LOG_API_KEY.
  # Exposes only /admin/logs (GET) and /admin/update (POST).
  # The main 'preview' container has NO Docker socket — this is intentional.
  #
  # Caddy on this VM should route /admin/* to admin-sidecar:8001.
  # Do NOT expose port 8001 to the public internet — let Caddy handle routing.
  admin-sidecar:
    container_name: preview-admin-sidecar
    build:
      # Build context is project root so Dockerfile can COPY backend/admin_sidecar/
      context: ../../
      dockerfile: backend/admin_sidecar/Dockerfile
    restart: unless-stopped
    environment:
      # Admin authentication — same key as the main service's ADMIN_LOG_API_KEY.
      # Set in .env: ADMIN_LOG_API_KEY=<random-secret>
      ADMIN_LOG_API_KEY: "${ADMIN_LOG_API_KEY:-}"

      # Docker Compose project to query and manage
      COMPOSE_PROJECT: "openmates-preview"

      # Path to the compose file (relative to GIT_WORK_DIR)
      COMPOSE_FILE: "backend/preview/docker-compose.preview.yml"

      # Which services are queryable via /admin/logs
      SERVICES_ALLOWED: "preview"

      # Which service to rebuild and restart via /admin/update
      SERVICE_UPDATE_TARGET: "preview"

      # Git repository root on the host (where `git pull` runs).
      # Must be set in .env (e.g. GIT_WORK_DIR=/home/superdev/projects/OpenMates).
      GIT_WORK_DIR: "${GIT_WORK_DIR}"

      PORT: "8001"
    # Bind to localhost only — Caddy proxies from the outside
    ports:
      - "127.0.0.1:8001:8001"
    volumes:
      # Docker socket — this container needs it; the main preview container does NOT
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount the project root so `git pull` and `docker compose` can run.
      # GIT_WORK_DIR must be set in .env (e.g. /home/superdev/projects/OpenMates).
      - type: bind
        source: "${GIT_WORK_DIR}"
        target: "${GIT_WORK_DIR}"
    group_add:
      # Add the docker group so this container can access the Docker socket.
      # Find the GID with: stat -c %g /var/run/docker.sock
      # Typically 999 on Debian/Ubuntu — may vary per host.
      - "${DOCKER_GID:-999}"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

# Named volumes for persistence
volumes:
  preview-cache:
    name: openmates-preview-cache
