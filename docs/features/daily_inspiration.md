# Daily Inspiration

## Overview
Daily Inspiration is a feature that provides users with three curated, thought-provoking prompts each day designed to spark curiosity, encourage exploration, and inspire learning. These inspirations appear as interactive banners in the new chat screen, allowing users to discover fascinating topics and start meaningful conversations.

## Purpose
Daily Inspiration aims to:
- Encourage curiosity-driven learning and exploration
- Present users with interesting facts, questions, and topics they might not have considered
- Create opportunities for discovery and intellectual growth
- Provide visually engaging conversation starters that inspire deeper engagement

## Architecture

### Post-Processing Integration

#### Topic Suggestions Collection
During the post-processing phase of message handling, the system collects topic suggestions that inform daily inspiration generation:

- **Output Field**: `daily_inspiration_topic_suggestions` (array of 3 topic suggestions)
- **Collection Point**: Post-processing LLM call (same stage as follow-up and new chat suggestions)
- **Purpose**: These suggestions capture user interests and conversation topics that can inform personalized daily inspirations

#### Server-Side Caching
Topic suggestions are stored server-side with encryption and time-based expiration:

- **Storage**: Encrypted cache entries per user
- **Expiration**: 24 hours per entry
- **Retention**: Last 50 suggestions per user (rolling window)
- **Update Frequency**: Every time post-processing completes for a user message
- **Encryption**: Server-side encryption ensures privacy of user interests

### Daily Generation Process

#### Generation Schedule
Once per day, the system generates new daily inspirations for active users:

- **Trigger**: Scheduled daily job (executes once per 24-hour period)
- **Model**: Uses the default main processing model (more powerful than post-processing model)
- **Method**: Function calling to generate structured inspiration data
- **Scope**: Generates inspirations for all users who meet activity criteria
- **Processing**: **One LLM call per user** to prevent context mixing between different users' topic suggestions and preferences

#### Load Distribution
To prevent server overload and ensure scalability, daily inspiration generation is spaced out over time:

- **Distribution Strategy**: Instead of processing all users simultaneously, generation is distributed across a time window
- **Implementation Options**:
  - **Time-based staggering**: Process users in batches based on user ID hash or registration time
  - **Queue-based processing**: Use a job queue with rate limiting to process users gradually
  - **Geographic distribution**: Stagger generation based on user timezone to align with local "daily" cycles
- **Benefits**:
  - Prevents server resource spikes
  - More predictable load patterns
  - Better scalability as user base grows
  - Reduced risk of rate limiting from LLM providers
- **Considerations**:
  - Users may receive their daily inspirations at slightly different times
  - Generation window should complete within a reasonable timeframe (e.g., within 2-4 hours)
  - Failed generations can be retried without affecting the entire batch

#### Activity Criteria
New daily inspirations are only generated if:
- User has logged in within the last 24 hours, OR
- User has interacted with OpenMates within the last 24 hours

If a user hasn't been active, their existing daily inspirations are preserved (since they haven't seen them yet).

#### Generation Function Call Structure
Each daily inspiration contains:

1. **Phrase/Fact**: A thought-provoking phrase or fascinating fact that encourages exploration
   - Example: "The Meiji Restoration modernized Japan in just decades—want to discuss how they industrialized so rapidly?"
   - Designed to spark curiosity and invite conversation

2. **Image Search Query**: A search query string used to find a visually fitting image
   - Used with Brave search API to locate relevant images
   - Should be descriptive enough to find appropriate visual content

3. **Chat Title**: The title that will be used when the user starts a chat from this inspiration
   - Generated by the LLM (similar to how preprocessor generates chat titles)
   - Should be concise and descriptive

4. **Category/Mate**: The mate (category) that best fits this inspiration
   - Used to determine the background color of the inspiration banner
   - Helps users understand the type of conversation they'll have

### Image Processing

#### Image Search and Selection
Images are retrieved via Brave search API using the generated search query:

- **Source**: Brave search API (via search skill)
- **Selection Criteria**: From the first 10 results, select the image closest to square format
- **Selection Method**: Compare `properties.width` and `properties.height` to find aspect ratio closest to 1:1
- **Fallback**: If no square images found, select the most square-like from available results

#### Image Processing Pipeline
Selected images undergo processing before storage:

1. **Download**: Fetch the original image from the source URL
2. **Resize**: Scale down to 220x220 pixels
3. **Crop**: Ensure square format (220x220px) if needed
4. **Storage**: Store processed image on `previews.openmates.org` server (consistent with other image storage in the system)
5. **Metadata**: Store original image URL and provider information

#### Image URL and Favicon
For each daily inspiration image:

- **Original URL**: Stored to enable opening source in new tab
- **Favicon**: Extracted and stored from the image provider's domain
- **Display**: Favicon shown in UI to indicate image source
- **Click Behavior**: Clicking the image opens the original source URL in a new tab

## User Interface

### Banner Display
Daily inspirations appear as banners at the top of the new chat screen:

- **Location**: Top of the new chat interface
- **Quantity**: Up to 3 inspirations visible
- **Interaction**: Swipe or click through inspirations using navigation arrows
- **Visual Design**: Each banner displays:
  - Processed 220x220px image
  - Inspiration phrase/fact text
  - "Click to start chat" button
  - Background color based on category/mate
  - Favicon indicating image source

### Time-Based Sorting
The order of daily inspirations changes based on time of day:

- **5:00 AM - 1:00 PM (5-13)**: First inspiration optimized for morning engagement
- **1:00 PM - 9:00 PM (13-21)**: First inspiration optimized for afternoon/evening engagement
- **9:00 PM - 5:00 AM (21-5)**: First inspiration optimized for evening/night engagement

This ensures users see the most relevant inspiration first based on their typical usage patterns.

### Chat Initiation
When a user clicks "Click to start chat" on a daily inspiration:

1. **Local Chat Creation**: A new chat is created **locally only** (no server request initially)
   - Chat is created with predefined title and assistant message
   - Follows the standard client-side encryption system
   - Chat is synced to other devices automatically (same as any other chat)
   
2. **Initial Message**: The inspiration phrase/fact is set as the assistant's first message
   - Example: "The Meiji Restoration modernized Japan in just decades—want to discuss how they industrialized so rapidly?"
   
3. **Chat Title**: Pre-populated with the generated title from the inspiration
   
4. **Mate/Category**: Set to the inspiration's category
   
5. **Web Search Embed**: The chat automatically includes the web search skill as an embed
   - Shows all the images that were searched during inspiration generation
   - Displays the full image search results from Brave search
   - Provides visual context for the inspiration topic
   
6. **LLM Inference**: **No LLM inference occurs** until the user responds to the chat
   - The initial message and embed are pre-generated
   - User must send a message to trigger normal chat processing and billing

## Billing and Cost Management

### Free Generation
Daily inspiration generation is **not billed to users**:

- **Generation Cost**: Absorbed by the platform (not charged to user account)
- **Purpose**: Encourage exploration without financial barriers
- **Follow-up Costs**: Normal billing applies to all user messages after the initial inspiration

### Cost Optimization
To manage generation costs:

- **Individual Processing**: One LLM call per user (prevents context mixing, ensures personalized results)
- **Activity Filtering**: Only generate for active users (reduces unnecessary API calls)
- **Caching**: Reuse topic suggestions from cache to inform generation context

## Data Flow

### Topic Suggestion Collection
```
User Message → Post-Processing → Extract daily_inspiration_topic_suggestions → 
Encrypt → Store in Cache (24h expiry, last 50 per user)
```

### Daily Inspiration Generation
```
Daily Scheduled Job → Identify Active Users → 
Distribute Users Across Time Window (load balancing) → 
For Each Active User (staggered processing):
  Load Last 50 Topic Suggestions → 
  Individual LLM Function Call (one per user) → 
  Generate 3 Inspirations → 
  For Each Inspiration:
    Image Search (Brave) → 
    Image Processing (220x220px) → 
    Upload to previews.openmates.org → 
  Store Inspiration Data → 
Deliver to UI (as each user's generation completes)
```

### User Interaction
```
User Views Banner → Swipes/Selects Inspiration → 
Clicks "Start Chat" → Local Chat Created (encrypted, synced) → 
Inspiration Message + Web Search Embed Displayed → 
User Responds → LLM Inference Triggered → 
Normal Chat Flow (billed)
```

## Technical Implementation Details

### Cache Structure
```python
# Pseudo-structure for topic suggestions cache
cache_key = f"daily_inspiration_topics:{user_id}"
cache_value = {
    "suggestions": [
        {"topic": "...", "timestamp": "..."},
        # ... up to 50 entries
    ],
    "last_updated": "..."
}
expiry = 24_hours
```

### Daily Inspiration Data Structure
```python
# Structure for each daily inspiration
{
    "id": "unique_inspiration_id",
    "phrase": "The Meiji Restoration modernized Japan...",
    "image_url": "https://...",
    "image_processed_url": "https://previews.openmates.org/.../220x220_image.jpg",
    "image_source_url": "https://original-source.com/image.jpg",
    "image_favicon": "https://source.com/favicon.ico",
    "chat_title": "Meiji Restoration Discussion",
    "category": "history",
    "mate": "history_mate",
    "background_color": "#hex_color",
    "generated_at": "2024-01-15T10:00:00Z",
    "expires_at": "2024-01-16T10:00:00Z"
}
```

### Function Calling Schema
The LLM function for generating daily inspirations should accept:
- User's recent topic suggestions (last 50)
- User's chat history summary (optional, for personalization)
- Current date/time context

And return:
- Array of 3 inspiration objects, each containing:
  - `phrase`: The inspiration text
  - `image_search_query`: Query for image search (used to generate web search embed)
  - `chat_title`: Title for the chat
  - `category`: Category/mate identifier

**Note**: The image search query is also used to generate the web search skill embed that appears in the chat when the user clicks "Start Chat". This embed shows all the images that were searched, providing visual context for the inspiration.

## Future Enhancements

### Potential Improvements
- **Personalization**: Use more user context (past chats, interests) to generate highly relevant inspirations
- **A/B Testing**: Test different inspiration styles and formats
- **User Feedback**: Allow users to rate or provide feedback on inspirations
- **Analytics**: Track which inspirations lead to longer, more engaging conversations
- **Diversity**: Ensure inspirations cover diverse topics and avoid repetition
- **Localization**: Adapt inspiration content and language for different regions

### Integration Opportunities
- **Learning Paths**: Connect inspirations to structured learning paths
- **Community Sharing**: Allow users to share interesting inspirations with others
- **Follow-up Suggestions**: Link daily inspirations to follow-up conversation suggestions
- **Weekly Themes**: Organize inspirations around weekly themes or topics

## Error Handling

### Generation Failures
- **Graceful Degradation**: If generation fails, show previous day's inspirations
- **Retry Logic**: Implement retry mechanism for transient failures
- **Logging**: Comprehensive logging for debugging generation issues

### Image Processing Failures
- **Fallback Images**: Use default placeholder if image processing fails
- **URL Validation**: Validate image URLs before processing
- **Timeout Handling**: Set appropriate timeouts for image downloads

### Cache Failures
- **Default Behavior**: If cache unavailable, generate without topic suggestions
- **Recovery**: Rebuild cache from recent post-processing results if needed

## Security and Privacy

### Data Protection
- **Encryption**: All topic suggestions encrypted server-side
- **User Isolation**: Each user's inspirations are isolated and private
- **No PII**: Inspiration generation doesn't expose personal information

### Image Security
- **URL Validation**: Validate and sanitize image URLs
- **Content Filtering**: Ensure images meet content guidelines (use safe search via brave search API)
- **Source Attribution**: Properly attribute image sources