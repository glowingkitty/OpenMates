# Translations Architecture

## Overview

OpenMates uses a YAML-based translation system where **YAML files are the source of truth**. These YAML files are automatically converted to JSON files during the build process for runtime use. This approach provides:

- **Better maintainability**: YAML files are easier to read and edit than nested JSON
- **Automatic file splitting**: Large translation files are automatically split into subdirectories for better organization
- **Multi-line support**: Long text with line breaks is more readable in YAML format
- **Missing translation visibility**: Empty strings show which languages need translations

## File Structure

### Source Files (YAML)

Translation source files are located in:
```
frontend/packages/ui/src/i18n/sources/
```

**Structure:**
- Top-level files: `email.yml`, `login.yml`, `signup.yml`, etc.
- Subdirectories for large namespaces: `settings/app_store.yml`, `settings/billing.yml`, etc.
- Files are automatically split when they exceed 500 lines

**Example structure:**
```
sources/
â”œâ”€â”€ email.yml
â”œâ”€â”€ login.yml
â”œâ”€â”€ settings/
â”‚   â”œâ”€â”€ main.yml          # Top-level settings keys
â”‚   â”œâ”€â”€ app_store.yml     # App store related translations
â”‚   â”œâ”€â”€ billing.yml       # Billing related translations
â”‚   â””â”€â”€ interface.yml     # Interface settings translations
â””â”€â”€ signup/
    â”œâ”€â”€ main.yml
    â””â”€â”€ steps.yml
```

### Generated Files (JSON)

JSON files are **automatically generated** during the build process and should **NOT** be committed to git. They are located in:
```
frontend/packages/ui/src/i18n/locales/
```

**Note:** These files are in `.gitignore` and are generated by running `npm run build:translations`.

## YAML File Format

Each YAML file contains translation keys with the following structure:

```yaml
# Simple key example
confirm_email:
  context: "Email subject for email confirmation"
  en: "Confirm your email address"
  de: "BestÃ¤tige deine E-Mail Adresse"
  es: "Confirma tu direcciÃ³n de correo electrÃ³nico"
  fr: "Confirmez votre adresse e-mail"
  # ... all other languages (empty string "" if missing)
  it: ""
  pt: ""
  # etc.

# Multi-line text example (for markdown content)
welcome_message:
  context: "Welcome message in demo chat"
  en: |
    # Welcome to OpenMates! ðŸ‘‹
    
    I'm your AI teammate - here to help you learn, solve problems, and think through challenges.
    
    ## What you can do:
    
    - **Learn topics deeply**
    - **Get coding help**
    - **Think through decisions**
  de: |
    # Willkommen bei OpenMates! ðŸ‘‹
    
    Ich bin dein KI-Teamkollege - hier, um dir beim Lernen, ProblemlÃ¶sen und Nachdenken zu helfen.
    
    ## Was du tun kannst:
    
    - **Themen tiefgehend lernen**
    - **Programmierhilfe erhalten**
    - **Entscheidungen durchdenken**
  # ... other languages
```

### Key Rules

1. **Language order**: Always `en` first, then `de`, then rest alphabetically
2. **Empty strings**: Use `""` for missing translations (makes it easy to see what needs translation)
3. **Context field**: Include `context` to help translators understand usage (not included in generated JSON)
4. **Multi-line text**: Use YAML literal block scalars (`|`) for text with line breaks
5. **Empty lines**: One empty line between each translation key for readability

## Adding or Editing Translations

### Where to Add Translations

1. **Find the appropriate YAML file** in `frontend/packages/ui/src/i18n/sources/`
2. **Add or edit the translation key** following the format above
3. **Include all languages** - use empty string `""` if translation is missing
4. **Run the build script** to generate JSON files

### Example: Adding a New Translation

1. Open the relevant YAML file (e.g., `sources/email.yml`)
2. Add your translation key:

```yaml
new_feature_announcement:
  context: "Announcement about a new feature"
  en: "Check out our new feature!"
  de: "Schau dir unsere neue Funktion an!"
  es: "Â¡Echa un vistazo a nuestra nueva funciÃ³n!"
  fr: "DÃ©couvrez notre nouvelle fonctionnalitÃ© !"
  # ... add all other languages
```

3. Run the build script:
```bash
cd frontend/packages/ui && npm run prepare
```

**Note:** The `prepare` script runs `build:translations`, `validate:locales`, and `generate-apps-metadata` in sequence. You can also run them individually if needed.

4. Use in code:
```typescript
import { text } from '@repo/ui';

const message = $text('email.new_feature_announcement.text');
```

### Example: Editing Existing Translation

1. Open the YAML file containing the key
2. Update the translation for the desired language(s)
3. Run `npm run prepare` (or `npm run build:translations` if you only need to build translations)
4. Test the change in the application

## Build Process

### Building Translations

The build process consists of three steps that should be run together:

```bash
cd frontend/packages/ui && npm run prepare
```

This runs:
1. `build:translations` - Converts YAML source files to JSON locale files
2. `validate:locales` - Validates that all translations are properly formatted
3. `generate-apps-metadata` - Generates app metadata from translations

**What `build:translations` does:**
1. Recursively loads all YAML files from `sources/` (including subdirectories)
2. Merges files from the same namespace (e.g., `settings/main.yml` + `settings/app_store.yml`)
3. Converts YAML structure to nested JSON structure
4. Preserves newlines as `\n` (for markdown compatibility)
5. Removes `context` fields (only used in YAML for documentation)
6. Generates JSON files for all 25 supported languages

**When to run:**
- After editing any YAML files
- Before committing changes
- During the build process (should be automated in CI/CD)

**Note:** You can run individual scripts if needed:
- `npm run build:translations` - Only build translations
- `npm run validate:locales` - Only validate locales
- `npm run generate-apps-metadata` - Only generate app metadata

### Automatic File Splitting

The migration script automatically splits large files (>500 lines) into subdirectories:

- `settings.yml` â†’ `settings/main.yml`, `settings/app_store.yml`, etc.
- Keys are grouped by their top-level prefix
- Translation keys remain the same (e.g., `settings.app_store.text` works regardless of file structure)

## Supported Languages

OpenMates supports **25 languages**:

**EU Languages:**
- English (en), German (de), Spanish (es), French (fr), Italian (it), Portuguese (pt)
- Dutch (nl), Polish (pl), Romanian (ro), Czech (cs), Swedish (sv), Finnish (fi)
- Greek (el), Hungarian (hu), Bulgarian (bg), Croatian (hr), Slovak (sk), Slovenian (sl)
- Lithuanian (lt), Latvian (lv), Estonian (et), Irish (ga), Maltese (mt)

**Other Languages:**
- Japanese (ja), Chinese (zh)

## Using Translations in Code

### Frontend (Svelte/TypeScript)

```typescript
import { text } from '@repo/ui';

// Simple usage
const errorMessage = $text('signup.at_missing.text');

// With HTML rendering
const htmlContent = {@html $text('email.welcome_message.text')};
```

### Backend (Python)

```python
from backend.core.api.app.services.translations import TranslationService

translation_service = TranslationService()
language = 'en'
text = translation_service.get_nested_translation("email.confirm_email.text", language, {})
```

## Translation Key Structure

Translation keys use dot notation to represent nested structure:

- `settings.app_store.text` â†’ `settings.app_store` namespace, `text` field
- `email.confirm_email.text` â†’ `email` namespace, `confirm_email` key, `text` field
- `signup.steps.profile.text` â†’ `signup` namespace, nested `steps.profile` key, `text` field

**Important:** Always append `.text` when accessing translations in code, as the JSON structure has a `text` field containing the actual translation string.

## Best Practices

1. **Always include all languages**: Even if empty (`""`), this makes it clear what needs translation
2. **Use context fields**: Help translators understand where and how translations are used
3. **Keep files organized**: Large namespaces are automatically split, but you can manually organize if needed
4. **Test after changes**: Always run `npm run build:translations` and test the application
5. **Don't commit JSON files**: Only YAML source files should be in version control
6. **Use multi-line format**: For long text or markdown content, use YAML literal block scalars (`|`)

## Troubleshooting

### Missing Translation Key

If you see an error like `The message "settings.app_store.categories.most_used.text" was not found`:

1. Check if the key exists in the YAML source files
2. Run `npm run prepare` (or `npm run build:translations`) to regenerate JSON files
3. Verify the key path is correct (check for typos in namespace/key names)

### Translation Not Updating

1. Make sure you ran `npm run prepare` (or `npm run build:translations`) after editing YAML files
2. Clear browser cache if testing in browser
3. Check that the translation key path matches exactly (case-sensitive)

### File Too Large

Files are automatically split when they exceed 500 lines. If you need to manually organize:

1. Create a subdirectory (e.g., `settings/`)
2. Move related keys to separate files (e.g., `settings/app_store.yml`)
3. The build script will automatically merge them into the `settings` namespace

## File Organization

### Automatic Splitting

The system automatically splits files when:
- Estimated line count exceeds 500 lines
- File has more than 10 keys

Files are split by grouping keys with the same top-level prefix:
- `app_store.categories.top_picks` â†’ goes to `settings/app_store.yml` with key `categories.top_picks`
- `app_store` (top-level key) â†’ also goes to `settings/app_store.yml` as `app_store`

### Manual Organization

You can manually organize files by:
1. Creating subdirectories in `sources/`
2. Moving related keys to separate files
3. The build script will automatically merge them

**Example:**
```
sources/
â”œâ”€â”€ email/
â”‚   â”œâ”€â”€ main.yml          # General email translations
â”‚   â”œâ”€â”€ confirmation.yml  # Email confirmation specific
â”‚   â””â”€â”€ notifications.yml # Email notifications
```

All files in `email/` contribute to the `email` namespace in the generated JSON.
