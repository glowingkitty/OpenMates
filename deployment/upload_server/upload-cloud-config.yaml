#cloud-config
#
# Cloud-init template for the OpenMates Upload Server VM.
#
# DO NOT EDIT PLACEHOLDERS MANUALLY — use the render script instead:
#   python scripts/render-deploy-config.py deployment/upload_server/upload-cloud-config.yaml
#
# The script reads DEPLOY_* variables from your .env file and outputs
# a ready-to-paste cloud-init YAML with all values filled in.
#
# WHAT THIS DOES (automated on first boot):
#   - Creates a non-root user with sudo, disables root login + password SSH
#   - Updates the OS and installs essential packages
#   - Installs Docker, Docker Compose, and Caddy (via official repos)
#   - Clones the repo (dev branch) into ~/projects/OpenMates
#   - Writes and applies the production Caddyfile (TLS + reverse proxy)
#   - Configures UFW firewall (only ports 22, 80, 443)
#   - Configures fail2ban for SSH brute-force protection
#
# MANUAL STEPS AFTER SSH-ING IN (secrets only):
#   1. Create ~/projects/OpenMates/backend/apps/uploads/.env:
#      cp ~/projects/OpenMates/backend/apps/uploads/.env.example \
#         ~/projects/OpenMates/backend/apps/uploads/.env
#      nano ~/projects/OpenMates/backend/apps/uploads/.env
#   2. Start the upload server:
#      cd ~/projects/OpenMates
#      docker compose -f backend/apps/uploads/docker-compose.yml \
#                     -f backend/apps/uploads/docker-compose.prod.yml up -d
#   3. Verify: curl https://${DEPLOY_UPLOAD_DOMAIN}/health

# ---------------------------------------------------------------------------
# User setup
# ---------------------------------------------------------------------------
users:
  - name: ${DEPLOY_USERNAME}
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${DEPLOY_SSH_PUBLIC_KEY}

# Disable root login and password authentication
ssh_pwauth: false
disable_root: true

# ---------------------------------------------------------------------------
# System updates and package installation
# ---------------------------------------------------------------------------
package_update: true
package_upgrade: true

packages:
  - ufw
  - fail2ban
  - git
  - curl
  - wget
  - unzip
  - htop
  - nano

# ---------------------------------------------------------------------------
# Runtime commands (executed in order on first boot)
# ---------------------------------------------------------------------------
runcmd:
  # --- Install Docker ---
  - curl -fsSL https://get.docker.com -o get-docker.sh
  - sh get-docker.sh
  - usermod -aG docker ${DEPLOY_USERNAME}
  - systemctl enable docker
  - systemctl start docker
  - rm -f get-docker.sh

  # --- Install Docker Compose (standalone binary) ---
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose

  # --- Install Caddy (official Debian repo) ---
  # write_files runs before runcmd, so the production Caddyfile already exists.
  # DEBIAN_FRONTEND=noninteractive + --force-confold prevents dpkg from prompting
  # about the existing Caddyfile (it would hang with no stdin in cloud-init).
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
  - apt update
  - DEBIAN_FRONTEND=noninteractive apt install -y -o DPkg::options::="--force-confold" caddy
  - systemctl enable caddy

  # --- Clone repo ---
  - sudo -u ${DEPLOY_USERNAME} mkdir -p /home/${DEPLOY_USERNAME}/projects
  - sudo -u ${DEPLOY_USERNAME} git clone --branch dev https://github.com/glowingkitty/OpenMates.git /home/${DEPLOY_USERNAME}/projects/OpenMates

  # --- Configure UFW firewall ---
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # --- Configure fail2ban ---
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # --- Set up Caddy log directory ---
  # Must run after Caddy is installed so the caddy system user exists.
  - mkdir -p /var/log/caddy
  - chown -R caddy:caddy /var/log/caddy

  # --- Apply production Caddyfile ---
  # Write the final Caddyfile (with DEPLOY_* vars already substituted by the
  # render script at provisioning time) and reload Caddy.
  - systemctl reload caddy
  - systemctl start caddy

# ---------------------------------------------------------------------------
# Config files written on first boot
# ---------------------------------------------------------------------------
write_files:
  # Production Caddyfile — DEPLOY_* placeholders are substituted by the render
  # script at provisioning time (before pasting into Hetzner user data).
  - path: /etc/caddy/Caddyfile
    content: |
      {
        email ${DEPLOY_ACME_EMAIL}
      }

      ${DEPLOY_UPLOAD_DOMAIN} {
        log {
          output file /var/log/caddy/${DEPLOY_UPLOAD_DOMAIN}.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 720h
          }
          format json
          level INFO
        }

        encode gzip zstd

        header {
          Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
          X-Content-Type-Options "nosniff"
          X-Frame-Options "DENY"
          Referrer-Policy "strict-origin-when-cross-origin"
          Permissions-Policy "geolocation=(), microphone=(), camera=(), interest-cohort=()"
          -Server
        }

        @upload_health path /health
        @upload_api path /v1/upload/*
        @upload_options method OPTIONS

        route {
          handle @upload_options {
            reverse_proxy localhost:8000 {
              header_up Host {http.request.host}
            }
          }
          handle @upload_health {
            reverse_proxy localhost:8000 {
              header_up Host {http.request.host}
            }
          }
          handle @upload_api {
            reverse_proxy localhost:8000 {
              header_up Host {http.request.host}
            }
          }
          handle {
            abort
          }
        }
      }
    owner: root:root
    permissions: "0644"

  # fail2ban SSH jail
  - path: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600
      findtime = 600
    permissions: "0644"

# ---------------------------------------------------------------------------
# Final message (shown in cloud-init logs)
# ---------------------------------------------------------------------------
final_message: |
  Upload Server cloud-init complete.
  SSH in as '${DEPLOY_USERNAME}' and run the following commands:

  1. Fill in the secrets:
     cp ~/projects/OpenMates/backend/apps/uploads/.env.example \
        ~/projects/OpenMates/backend/apps/uploads/.env
     nano ~/projects/OpenMates/backend/apps/uploads/.env

  2. Start the upload server:
     cd ~/projects/OpenMates
     docker compose -f backend/apps/uploads/docker-compose.yml \
                    -f backend/apps/uploads/docker-compose.prod.yml up -d

  3. Verify:
     curl https://${DEPLOY_UPLOAD_DOMAIN}/health
