#cloud-config
#
# Cloud-init template for the OpenMates Upload Server VM.
#
# DO NOT EDIT PLACEHOLDERS MANUALLY — use the render script instead:
#   python scripts/render-deploy-config.py deployment/upload_server/upload-cloud-config.yaml
#
# The script reads DEPLOY_* variables from your .env file and outputs
# a ready-to-paste cloud-init YAML with all values filled in.
#
# WHAT THIS DOES (automated on first boot):
#   - Creates a non-root user with sudo, disables root login + password SSH
#   - Updates the OS and installs essential packages
#   - Installs Docker, Docker Compose, and Caddy (via official repos)
#   - Clones the repo (dev branch) into ~/projects/OpenMates
#   - Configures UFW firewall (only ports 22, 80, 443)
#   - Configures fail2ban for SSH brute-force protection
#   - Writes an initial Caddyfile placeholder (replaced in manual steps)
#
# MANUAL STEPS AFTER SSH-ING IN:
#   1. Create ~/projects/OpenMates/backend/apps/uploads/.env (see .env.example)
#   2. Render and apply the production Caddyfile:
#      python scripts/render-deploy-config.py deployment/upload_server/Caddyfile \
#        | sudo tee /etc/caddy/Caddyfile > /dev/null
#      sudo systemctl reload caddy
#   3. Start the upload server:
#      cd ~/projects/OpenMates
#      docker compose -f backend/apps/uploads/docker-compose.yml \
#                     -f backend/apps/uploads/docker-compose.prod.yml up -d
#   4. Verify: curl https://${DEPLOY_UPLOAD_DOMAIN}/health

# ---------------------------------------------------------------------------
# User setup
# ---------------------------------------------------------------------------
users:
  - name: ${DEPLOY_USERNAME}
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${DEPLOY_SSH_PUBLIC_KEY}

# Disable root login and password authentication
ssh_pwauth: false
disable_root: true

# ---------------------------------------------------------------------------
# System updates and package installation
# ---------------------------------------------------------------------------
package_update: true
package_upgrade: true

packages:
  - ufw
  - fail2ban
  - git
  - curl
  - wget
  - unzip
  - htop
  - nano

# ---------------------------------------------------------------------------
# Runtime commands (executed in order on first boot)
# ---------------------------------------------------------------------------
runcmd:
  # --- Install Docker ---
  - curl -fsSL https://get.docker.com -o get-docker.sh
  - sh get-docker.sh
  - usermod -aG docker ${DEPLOY_USERNAME}
  - systemctl enable docker
  - systemctl start docker
  - rm -f get-docker.sh

  # --- Install Docker Compose (standalone binary) ---
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose

  # --- Install Caddy (official Debian repo) ---
  # write_files runs before runcmd, so the placeholder Caddyfile already exists.
  # DEBIAN_FRONTEND=noninteractive + --force-confold prevents dpkg from prompting
  # about the existing Caddyfile (it would hang with no stdin in cloud-init).
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
  - apt update
  - DEBIAN_FRONTEND=noninteractive apt install -y -o DPkg::options::="--force-confold" caddy
  - systemctl enable caddy

  # --- Clone repo ---
  - sudo -u ${DEPLOY_USERNAME} mkdir -p /home/${DEPLOY_USERNAME}/projects
  - sudo -u ${DEPLOY_USERNAME} git clone --branch dev https://github.com/glowingkitty/OpenMates.git /home/${DEPLOY_USERNAME}/projects/OpenMates

  # --- Configure UFW firewall ---
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # --- Configure fail2ban ---
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # --- Set up Caddy log directory ---
  # Must run after Caddy is installed so the caddy system user exists.
  - mkdir -p /var/log/caddy
  - chown -R caddy:caddy /var/log/caddy
  - systemctl start caddy

# ---------------------------------------------------------------------------
# Config files written on first boot
# ---------------------------------------------------------------------------
write_files:
  # Placeholder Caddyfile — replaced after cloning the repo (manual step 5)
  - path: /etc/caddy/Caddyfile
    content: |
      :80 {
        respond "Upload server — Caddy not yet configured" 503
      }
    owner: root:root
    permissions: "0644"

  # fail2ban SSH jail
  - path: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600
      findtime = 600
    permissions: "0644"

# ---------------------------------------------------------------------------
# Final message (shown in cloud-init logs)
# ---------------------------------------------------------------------------
final_message: |
  Upload Server cloud-init complete.
  SSH in as '${DEPLOY_USERNAME}' and complete the 4 manual steps in the template header.
