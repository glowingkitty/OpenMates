# deployment/upload_server/Caddyfile
#
# Production Caddyfile template for the OpenMates Upload Server VM.
#
# BEFORE USING: Replace ALL <PLACEHOLDER> values with your actual values.
# Search for "<" to find all placeholders that need replacing.
#
# DEPLOYMENT:
#   sudo cp ~/projects/OpenMates/deployment/upload_server/Caddyfile /etc/caddy/Caddyfile
#   # Edit to replace <PLACEHOLDER> values
#   sudo systemctl reload caddy
#
# WHAT THIS DOES:
#   - Terminates TLS via Let's Encrypt for the upload domain
#   - Proxies /health and /v1/upload/* to the app-uploads container on localhost:8000
#   - Adds security headers (HSTS, nosniff, etc.)
#   - Aborts all requests to paths not explicitly allowed
#   - Logs requests in JSON format for monitoring
#
# SECURITY:
#   - Only /health and /v1/upload/* are routed — everything else is aborted
#   - The upload container is only exposed on localhost (127.0.0.1:8000)
#   - CORS is handled by the upload service itself (FastAPI middleware)

{
	# Email for ACME account (Let's Encrypt certificate issuance)
	email <YOUR_ACME_EMAIL>
}

<YOUR_UPLOAD_DOMAIN> {
	# --- Logging ---
	log {
		output file /var/log/caddy/<YOUR_UPLOAD_DOMAIN>.log {
			roll_size 100mb
			roll_keep 10
			roll_keep_for 720h # 30 days
		}
		format json
		level INFO
	}

	# --- Compression ---
	encode gzip zstd

	# --- Security Headers ---
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=(), interest-cohort=()"
		-Server
	}

	# --- Request Matchers ---
	@upload_health path /health
	@upload_api path /v1/upload/*
	@upload_options method OPTIONS

	# --- Request Routing ---
	route {
		# 1. Handle OPTIONS preflight requests (CORS)
		#    The upload service's FastAPI CORS middleware handles the actual headers.
		#    Caddy just proxies the OPTIONS request through.
		handle @upload_options {
			reverse_proxy localhost:8000 {
				header_up Host {http.request.host}
			}
		}

		# 2. Health check endpoint (used by monitoring and smoke tests)
		handle @upload_health {
			reverse_proxy localhost:8000 {
				header_up Host {http.request.host}
			}
		}

		# 3. Upload API endpoints (/v1/upload/*)
		handle @upload_api {
			reverse_proxy localhost:8000 {
				header_up Host {http.request.host}
			}
		}

		# 4. Abort all other requests — no other paths should be accessible
		handle {
			abort
		}
	}
}
