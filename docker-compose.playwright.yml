services:
  playwright:
    # Official Playwright image with browsers and Node pre-installed.
    image: mcr.microsoft.com/playwright:v1.49.0-jammy
    working_dir: /workspace
    volumes:
      # Mount only the Playwright config and tests; no need for the app code.
      - ./frontend/apps/web_app/playwright.config.ts:/workspace/playwright.config.ts:ro
      - ./frontend/apps/web_app/tests:/workspace/tests:ro
      # Mount a writable directory for screenshots and other artifacts.
      - ./playwright-artifacts:/workspace/artifacts
    environment:
      # Target the deployed dev environment by default.
      PLAYWRIGHT_TEST_BASE_URL: "https://app.dev.openmates.org"
      # Load test credentials from host environment (populated via .env)
      OPENMATES_TEST_ACCOUNT_EMAIL:
      OPENMATES_TEST_ACCOUNT_PASSWORD:
      OPENMATES_TEST_ACCOUNT_OTP_KEY:
      # Load signup test vars
      SIGNUP_TEST_EMAIL_DOMAINS:
      MAILOSAUR_API_KEY:
      MAILOSAUR_SERVER_ID:
      # Allow targeting specific tests
      PLAYWRIGHT_TEST_FILE:
      PLAYWRIGHT_TEST_GREP:
    # NOTE: Use $$ to escape $ so docker-compose passes the variable expansion
    # to the shell inside the container, rather than evaluating it at parse time.
    command: >
      bash -lc "
        cd /workspace &&
        # Create an isolated, throwaway Playwright project inside the container.
        npm init -y >/dev/null 2>&1 &&
        npm install --silent @playwright/test@1.49.0 &&
        # Allow targeted runs without overriding the container command.
        # PLAYWRIGHT_TEST_FILE points at a single test file.
        # PLAYWRIGHT_TEST_GREP filters tests by title (regex).
        npx playwright test --config=playwright.config.ts $${PLAYWRIGHT_TEST_FILE:-} $${PLAYWRIGHT_TEST_GREP:+--grep \"$$PLAYWRIGHT_TEST_GREP\"}
      "

